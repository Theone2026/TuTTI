(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();document.addEventListener("DOMContentLoaded",function(){const t=JSON.parse(localStorage.getItem("user")),e=document.getElementById("user-menu"),r=document.getElementById("login-link"),n=document.getElementById("user-name"),o=document.getElementById("sell-link"),a=document.getElementById("logoutButton"),s=document.getElementById("dropdownMenu");t?(n.textContent=t.name,e.classList.remove("hidden"),r.classList.add("hidden"),t.role==="admin"&&o.classList.remove("hidden"),n.addEventListener("click",function(){s.classList.toggle("hidden")}),a.addEventListener("click",function(){localStorage.removeItem("user"),window.location.href="/login.html"})):(e.classList.add("hidden"),r.classList.remove("hidden"))});const m="http://localhost:3000";async function O(){try{const t=await fetch(`${m}/api/recent-products`);if(!t.ok)throw new Error("Error al cargar los productos");return(await t.json()).filter(r=>r.status!=="archived"&&r.status!=="out_of_stock")}catch(t){return console.error("Error en loadProducts:",t),[]}}function $(t,e="USD"){const r=parseFloat(t),n=e==="USD"?"US$":"$",o=new Intl.NumberFormat("es-ES",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2}).format(r);return`${n} ${o}`}function x(t){const e=document.getElementById("recent-products");if(!e){console.warn("Contenedor de productos recientes no encontrado.");return}e.innerHTML="";const r=t.filter(n=>!/EJEMPLO/i.test(n.name)&&n.stock>0);r.length>0?r.forEach(n=>{if(!n.name||!n.description||!n.price){console.warn("Producto incompleto, saltando:",n);return}const o=$(n.price,n.currency||"USD"),a=n.images&&n.images.length>0?n.images[0]:"/img/default-product.jpg",s=`
                <div class="product-card bg-white rounded-lg overflow-hidden shadow-md flex flex-col h-full">
                    <a href="producto.html?id=${n._id}" class="block h-48 overflow-hidden">
                        <img src="${a}" alt="${n.name}" class="w-full h-full object-cover object-center" onerror="this.src='/img/default-product.jpg'">
                    </a>
                    <div class="p-4 flex-grow">
                        <h3 class="text-lg font-semibold mb-2">${n.name}</h3>
                        <p class="text-gray-600 mb-2">${n.description.substring(0,100)}...</p>
                        <p class="text-xl font-bold text-primary">${o}</p>
                    </div>
                    <div class="p-4 bg-gray-50">
                        <button class="add-to-cart-btn w-full bg-primary text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors" data-product-id="${n._id}">
                            Agregar al carrito
                        </button>
                    </div>
                </div>
            `;e.innerHTML+=s}):e.innerHTML="<p class='text-gray-600'>No hay productos para mostrar.</p>"}async function A(){try{const t=await fetch(`${m}/api/ofertas-del-dia`,{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}});if(!t.ok){const o=await t.text();throw console.error("Raw response for ofertas del día (not OK):",o),new Error(`HTTP error! status: ${t.status}`)}const e=t.headers.get("content-type");if(!e||!e.includes("application/json")){const o=await t.text();throw console.error("Raw response for ofertas del día (not JSON):",o),new Error("La respuesta del servidor para ofertas del día no es JSON válido")}const r=await t.json(),n=document.getElementById("ofertas-del-dia");if(!n){console.warn("Element with ID 'ofertas-del-dia' not found, cannot display offers.");return}n.innerHTML="",r.length>0?r.slice(0,3).forEach(o=>{if(!o.image||!o.name||!o.price){console.warn("Oferta incompleta, saltando:",o);return}n.innerHTML+=`
                    <div class="flex items-center space-x-2">
                        <img src="${o.image}" alt="${o.name}" class="w-12 h-12 object-cover rounded">
                        <div>
                            <p class="text-sm font-semibold">${o.name}</p>
                            <p class="text-xs text-red-600">${$(o.price,o.currency)}</p>
                        </div>
                    </div>
                `}):n.innerHTML="<p>No hay ofertas del día disponibles.</p>"}catch(t){console.error("Error al cargar ofertas del día:",t);const e=document.getElementById("ofertas-del-dia");e&&(e.innerHTML="<p>No se pudieron cargar las ofertas del día.</p>")}}async function H(){try{const t=await fetch(`${m}/api/nuevos-ingresos`,{headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}});if(!t.ok){const o=await t.text();throw console.error("Raw response for nuevos ingresos (not OK):",o),new Error(`HTTP error! status: ${t.status}`)}const e=t.headers.get("content-type");if(!e||!e.includes("application/json")){const o=await t.text();throw console.error("Raw response for nuevos ingresos (not JSON):",o),new Error("La respuesta del servidor para nuevos ingresos no es JSON válido")}const r=await t.json(),n=document.getElementById("nuevos-ingresos");if(!n){console.warn("Element with ID 'nuevos-ingresos' not found, cannot display new arrivals.");return}n.innerHTML="",r.length>0?r.slice(0,3).forEach(o=>{if(!o.image||!o.name||!o.price){console.warn("Nuevo ingreso incompleto, saltando:",o);return}n.innerHTML+=`
                    <div class="flex items-center space-x-2">
                        <img src="${o.image}" alt="${o.name}" class="w-12 h-12 object-cover rounded">
                        <div>
                            <p class="text-sm font-semibold">${o.name}</p>
                            <p class="text-xs text-gray-600">${$(o.price,o.currency)}</p>
                        </div>
                    </div>
                `}):n.innerHTML="<p>No hay nuevos ingresos disponibles.</p>"}catch(t){console.error("Error al cargar nuevos ingresos:",t);const e=document.getElementById("nuevos-ingresos");e&&(e.innerHTML="<p>No se pudieron cargar los nuevos ingresos.</p>")}}function j(t,e){return t.filter(r=>r.category===e)}function k(t,e){return t.filter(r=>r.name.toLowerCase().includes(e.toLowerCase())||r.description.toLowerCase().includes(e.toLowerCase()))}let d=[];const E=document.getElementById("cartIcon"),I=document.getElementById("cartItemCount"),h=document.getElementById("miniCartDropdown"),f=document.getElementById("miniCartItems"),B=document.getElementById("miniCartTotal"),L=document.getElementById("emptyCartMessage"),T=document.getElementById("checkoutButton");async function D(){const t=localStorage.getItem("authToken");if(!t){d=[],I&&(I.textContent="0"),p();return}try{const e=await fetch(`${m}/api/cart`,{headers:{Authorization:`Bearer ${t}`}});e.ok?(d=await e.json(),p()):(console.error("Error al cargar el carrito:",e.statusText),d=[],p())}catch(e){console.error("Error de conexión al cargar el carrito:",e),d=[],p()}}function p(){f&&(f.innerHTML="");let t=0,e=0;d.length===0?L&&L.classList.remove("hidden"):(L&&L.classList.add("hidden"),d.forEach(r=>{const n=r.productId;if(!n)return;const o=n.price*r.quantity;t+=o,e+=r.quantity;const a=document.createElement("div");a.classList.add("flex","items-center","justify-between","py-2","border-b","border-gray-100"),a.innerHTML=`
                <div class="flex items-center">
                    <img src="${n.images&&n.images.length>0?n.images[0]:"/img/default-product.jpg"}" alt="${n.name}" class="w-12 h-12 object-cover rounded-md mr-3">
                    <div>
                        <p class="font-semibold text-sm">${n.name}</p>
                        <p class="text-gray-600 text-xs">${r.quantity} x ${n.currency}${n.price.toFixed(2)}</p>
                    </div>
                </div>
                <div class="flex items-center">
                    <button data-product-id="${n._id}" data-action="decrement" class="quantity-btn px-2 py-1 bg-gray-200 rounded-l hover:bg-gray-300">-</button>
                    <span class="px-2 text-sm">${r.quantity}</span>
                    <button data-product-id="${n._id}" data-action="increment" class="quantity-btn px-2 py-1 bg-gray-200 rounded-r hover:bg-gray-300">+</button>
                    <button data-product-id="${n._id}" data-action="remove" class="ml-3 text-red-500 hover:text-red-700 text-sm">X</button>
                </div>
            `,f&&f.appendChild(a)})),I&&(I.textContent=e),B&&(B.textContent=`${d.length>0&&d[0].productId?d[0].productId.currency:"€"}${t.toFixed(2)}`),f&&(f.querySelectorAll(".quantity-btn").forEach(r=>{r.addEventListener("click",q)}),f.querySelectorAll('button[data-action="remove"]').forEach(r=>{r.addEventListener("click",P)}))}async function S(t){const e=localStorage.getItem("authToken");if(!e){alert("Debes iniciar sesión para agregar productos al carrito."),window.location.href="/login.html";return}try{const r=await fetch(`${m}/api/cart/add`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({productId:t})}),n=await r.json();if(r.ok){console.log(n.message);const o=d.findIndex(a=>a.productId&&a.productId._id===n.cartItem.productId._id);o>-1?d[o].quantity=n.cartItem.quantity:d.push(n.cartItem),p(),alert(n.message)}else console.error("Error al agregar al carrito:",n.message),alert(`Error: ${n.message}`)}catch(r){console.error("Error al agregar al carrito (conexión):",r),alert("Hubo un error al agregar el producto al carrito.")}}async function q(t){const e=t.target.dataset.productId,r=t.target.dataset.action,n=localStorage.getItem("authToken"),o=d.find(s=>s.productId&&s.productId._id===e);if(!o)return;let a=o.quantity;if(r==="increment"?a+=1:r==="decrement"&&(a-=1),a<=0){P({target:{dataset:{productId:e}}});return}try{const s=await fetch(`${m}/api/cart/update-quantity/${e}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({quantity:a})}),i=await s.json();s.ok?(console.log(i.message),o.quantity=a,p()):(console.error("Error al actualizar cantidad:",i.message),alert(`Error: ${i.message}`))}catch(s){console.error("Error de conexión al actualizar cantidad:",s),alert("Hubo un error de conexión al actualizar la cantidad.")}}async function P(t){const e=t.target.dataset.productId,r=localStorage.getItem("authToken");if(confirm("¿Estás seguro de que quieres eliminar este producto del carrito?"))try{const n=await fetch(`${m}/api/cart/remove/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${r}`}}),o=await n.json();n.ok?(console.log(o.message),d=d.filter(a=>a.productId&&a.productId._id!==e),p()):(console.error("Error al eliminar del carrito:",o.message),alert(`Error: ${o.message}`))}catch(n){console.error("Error de conexión al eliminar del carrito:",n),alert("Hubo un error de conexión al eliminar el producto del carrito.")}}document.addEventListener("DOMContentLoaded",async()=>{await D(),E&&h&&(E.addEventListener("click",c=>{c.stopPropagation(),h.classList.toggle("hidden")}),document.addEventListener("click",c=>{h&&!h.contains(c.target)&&E&&!E.contains(c.target)&&h.classList.add("hidden")})),T&&T.addEventListener("click",()=>{if(d.length===0){alert("Tu carrito está vacío. Agrega productos antes de proceder al pago.");return}window.location.href="/checkout.html"});const t=await O();document.querySelector(".carousel")&&loadHeroBanner(t),x(t),checkUserSession(),await A(),await H(),document.querySelectorAll("[data-category]").forEach(c=>{c.addEventListener("click",()=>{const l=c.getAttribute("data-category"),u=j(t,l);x(u)})});const r=document.getElementById("searchInput"),n=document.getElementById("searchButton");n&&r&&(n.addEventListener("click",()=>{const c=r.value.trim(),l=k(t,c);x(l)}),r.addEventListener("keyup",c=>{if(c.key==="Enter"){const l=r.value.trim(),u=k(t,l);x(u)}}));const o=document.getElementById("loginForm"),a=document.getElementById("loginMessage"),s=document.getElementById("registerForm"),i=document.getElementById("registerMessage");o&&o.addEventListener("submit",async function(c){c.preventDefault();const l=o.email.value,u=o.password.value;try{const g=await fetch(`${m}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:l,password:u})}),v=await g.json();g.ok?(localStorage.setItem("authToken",v.token),a&&(a.textContent="Inicio de sesión exitoso.",a.classList.remove("hidden","bg-red-100","text-red-700"),a.classList.add("bg-green-100","text-green-700")),alert("Inicio de sesión exitoso!"),window.location.href="/dashboard.html"):a&&(a.textContent=v.message||"Credenciales inválidas.",a.classList.remove("hidden","bg-green-100","text-green-700"),a.classList.add("bg-red-100","text-red-700"))}catch(g){console.error("Error al iniciar sesión:",g),a&&(a.textContent="Hubo un error de conexión al iniciar sesión.",a.classList.remove("hidden","bg-green-100","text-green-700"),a.classList.add("bg-red-100","text-red-700"))}}),s&&s.addEventListener("submit",async function(c){c.preventDefault();const l=s.username.value,u=s.email.value,g=s.password.value,v=s.confirmPassword.value;if(g!==v){i&&(i.textContent="Las contraseñas no coinciden.",i.classList.remove("hidden"),i.classList.add("bg-red-100","text-red-700"));return}try{const w=await fetch(`${m}/api/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:l,email:u,password:g})}),N=await w.json();w.ok?(i&&(i.textContent="Registro exitoso. ¡Ahora puedes iniciar sesión!",i.classList.remove("hidden","bg-red-100","text-red-700"),i.classList.add("bg-green-100","text-green-700")),alert("Registro exitoso!"),window.location.href="/login.html"):i&&(i.textContent=N.message||"Error al registrar usuario.",i.classList.remove("hidden"),i.classList.add("bg-red-100","text-red-700"))}catch(w){console.error("Error al registrar:",w),i&&(i.textContent="Hubo un error de conexión al registrar tu cuenta.",i.classList.remove("hidden"),i.classList.add("bg-red-100","text-red-700"))}});const b=document.getElementById("address"),C=document.getElementById("editAddressButton");if(b&&C){const c=localStorage.getItem("address");c&&(b.value=c),C.addEventListener("click",function(){const l=prompt("Introduce tu nueva dirección:");l?(b.value=l,localStorage.setItem("address",l),alert("Dirección guardada.")):alert("Por favor, introduce una dirección válida.")})}document.querySelectorAll(".add-to-cart-btn").forEach(c=>{c.addEventListener("click",l=>{const u=l.target.dataset.productId;u?S(u):console.error('El botón "Agregar al Carrito" no tiene un data-product-id.')})})});window.addToCart=S;let y=[];function M(t){console.log("Notificación clickeada:",t),t.type==="comment"&&t.productId&&(window.location.href=`/producto.html?id=${t.productId}`)}function _(){const t=document.getElementById("notificationList");if(!t){console.error("Elemento notificationList no encontrado");return}t.innerHTML=y.map(e=>`
        <li class="notification-item hover:bg-gray-50 transition-colors duration-150 ease-in-out cursor-pointer" onclick="window.handleNotificationClick(${JSON.stringify(e)})">
            <div class="flex items-start p-4">
                <div class="flex-shrink-0 pt-1">
                    <i class="fas fa-bell text-blue-500 text-lg"></i>
                </div>
                <div class="ml-3 w-0 flex-1">
                    <p class="text-sm text-gray-900 font-medium">${e.message}</p>
                    <p class="mt-1 text-xs text-gray-500">${F(e.date)}</p>
                </div>
                <div class="ml-4 flex-shrink-0">
                    <button class="text-gray-400 hover:text-gray-500" onclick="event.stopPropagation(); window.markAsRead('${e.id}')">
                        <span class="sr-only">Cerrar</span>
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </li>
    `).join(""),y.length===0&&(t.innerHTML='<li class="p-4"><p class="text-sm text-gray-500 text-center">No hay notificaciones</p></li>')}function F(t){const e=new Date(t),n=Math.abs(new Date-e),o=Math.ceil(n/(1e3*60*60*24));return o<1?"Hoy":o===1?"Ayer":e.toLocaleDateString()}function J(t){const e=document.getElementById("notificationCount");e&&(e.textContent=t>0?t:"",e.classList.toggle("hidden",t===0))}async function R(t){try{if(!(await fetch(`/api/notifications/${t}/read`,{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("authToken")}`}})).ok)throw new Error("Error al marcar notificación como leída");y=y.filter(r=>r.id!==t),J(y.length),_()}catch(e){console.error("Error al marcar notificación como leída:",e)}}window.handleNotificationClick=M;window.markAsRead=R;window.handleNotificationClick=M;document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("notificationIcon"),e=document.getElementById("notificationPanel");t&&e&&(t.addEventListener("click",()=>{e.classList.contains("hidden")?(e.classList.remove("hidden","scale-95","opacity-0"),e.classList.add("scale-100","opacity-100")):(e.classList.remove("scale-100","opacity-100"),e.classList.add("scale-95","opacity-0"),setTimeout(()=>{e.classList.add("hidden")},200))}),document.addEventListener("click",r=>{!e.contains(r.target)&&!t.contains(r.target)&&(e.classList.contains("hidden")||(e.classList.remove("scale-100","opacity-100"),e.classList.add("scale-95","opacity-0"),setTimeout(()=>{e.classList.add("hidden")},200)))}))});
